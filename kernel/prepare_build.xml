<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="com.sos.scheduler.build" basedir=".">

  <taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="${env.USERPROFILE}/.m2/repository/ant-contrib/ant-contrib/1.0b3/ant-contrib-1.0b3.jar"/>
  
  <propertyregex property="base" override="true" global="true" input="${basedir}" regexp="\\" replace="/" defaultValue="${basedir}" />  
  <property name="source.root"        value="${base}/src/main" />
  <property name="script.root"        value="${source.root}/scripts" />
  <property name="perl.keywordtoxml"  value="${script.root}/scheduler_keyword_to_xml.pl" />
  <property name="script.keywordtoxml"  value="${script.root}/scheduler_keyword_to_xml" />
  <property name="generated.dir" value="${basedir}/target/generated" />
	<property name="dependency.dir" value="${basedir}/target/dependency" />
	<property name="doc.target.dir" value="${source.root}/doc" />
	<property name="common.generated.dir" value="${generated.dir}/com/sos/scheduler/enginedoc/common" />

  <property name="output.r" value="register_data.xml"/>

  <target name="all" depends="-prepare, -keywords.to.register_data.win, -keywords.to.register_data.ux, -copy.generated-files, -copy.common-files">
    <echo>DONE!</echo>
  </target>

  <target name="-prepare" description="prepare the build">
    <echo>base=${basedir}</echo>
    <mkdir dir="${generated.dir}" />
		<unzip dest="${generated.dir}">
	    <fileset dir="${dependency.dir}">
	        <include name="enginedoc-common-*.jar"/>
	    </fileset>
		</unzip>
  </target>

  <target name="-copy.generated-files" description="copy the generated files to the doc folder">
    <copy verbose="true" file="${generated.dir}/${output.r}" tofile="${doc.target.dir}/doc.de/${output.r}" />
    <copy verbose="true" file="${generated.dir}/${output.r}" tofile="${doc.target.dir}/doc.en/${output.r}" />
  </target>

  <target name="-copy.common-files" description="copy the common files to the doc folder">
    <copy verbose="true" todir="${doc.target.dir}/doc.de">
       <fileset dir="${common.generated.dir}">
          <exclude name="*messages*" />
       </fileset>
    </copy>
    <copy verbose="true" todir="${doc.target.dir}/doc.de/messages">
       <fileset dir="${common.generated.dir}">
          <include name="*messages*" />
       </fileset>
    </copy>
    <copy verbose="true" todir="${doc.target.dir}/doc.en">
       <fileset dir="${common.generated.dir}">
          <exclude name="*messages*" />
       </fileset>
    </copy>
    <copy verbose="true" todir="${doc.target.dir}/doc.en/messages">
       <fileset dir="${common.generated.dir}">
          <include name="*messages*" />
       </fileset>
    </copy>
  </target>

  <target name="-keywords.to.register_data.win" depends="-check.os" if="isWindows" description="generates register_data.xml">
    <echo>generating register-data.xml ...</echo>
    <propertyregex property="script.cygwin" override="true" global="true" input="${script.root}/scheduler_keyword_to_xml" regexp="^(.):(.*)" replace="/cygdrive/\1\2" />
    <echo>cygbase=${script.cygwin}</echo>
    <exec executable="bash" dir="${script.root}" output="${generated.dir}/${output.r}" logError="false">
      <arg value="-c" />
      <arg value="&quot;" />
      <arg value="${script.cygwin}" />
      <arg value="&quot;" />
    </exec>
  </target>

  <target name="-keywords.to.register_data.ux" depends="-check.os" if="isLinux" description="generates register_data.xml">
    <echo>generating register-data.xml ...</echo>
    <exec executable="${script.keywordtoxml}" dir="${script.root}" output="${generated.dir}/${output.r}" />
  </target>
  
  <target name="-check.os">
  	<condition property="isWindows">
  		<os family="windows" />
  	</condition>
  
  	<condition property="isLinux">
  		<os family="unix" />
  	</condition>
  </target>

</project>